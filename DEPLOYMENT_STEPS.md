# 클라우드 배포 환경 준비 - 단계별 작업 가이드

## 📋 전체 작업 개요

### 1단계: 클라우드 플랫폼 선택 및 계정 설정
### 2단계: 프로덕션 Docker 설정 최적화
### 3단계: 환경 변수 관리 (Secrets Manager) 설정
### 4단계: 데이터베이스 마이그레이션 전략 수립
### 5단계: CI/CD 파이프라인 구축

---

## 1단계: 클라우드 플랫폼 선택 및 계정 설정

### 1.1 플랫폼 비교 및 선택
- [ ] **플랫폼 비교표 작성**
  - AWS (EC2/ECS/EKS, RDS, S3)
  - GCP (Cloud Run, Cloud SQL, Cloud Storage)
  - Azure (App Service, Azure SQL, Blob Storage)
  - Vercel (프론트엔드) + Railway/Render (백엔드)
  - Railway (전체 스택)
  - Render (전체 스택)
  - Fly.io (전체 스택)

- [ ] **선택 기준 검토**
  - 비용 (월 예상 비용 계산)
  - 확장성 요구사항
  - 관리 편의성
  - 한국 리전 지원 여부
  - 무료 티어/크레딧 제공 여부

- [ ] **최종 플랫폼 결정 및 문서화**

### 1.2 계정 및 프로젝트 생성
- [ ] 클라우드 플랫폼 계정 생성
- [ ] 프로젝트/워크스페이스 생성
- [ ] 결제 정보 설정 (필요시)
- [ ] 초기 크레딧 확인

### 1.3 CLI 도구 설치 및 인증
- [ ] 플랫폼별 CLI 도구 설치
  - AWS: `aws-cli`
  - GCP: `gcloud`
  - Azure: `az`
  - Railway: `railway`
  - Render: `render-cli`
- [ ] CLI 인증 설정
- [ ] 기본 설정 확인

---

## 2단계: 프로덕션 Docker 설정 최적화

### 2.1 멀티 스테이지 Dockerfile 생성
- [ ] **프론트엔드 Dockerfile 생성** (`client/Dockerfile`)
  - 빌드 스테이지: Vite 빌드
  - 프로덕션 스테이지: Nginx로 정적 파일 서빙
  - 최적화: 이미지 크기 최소화, 레이어 캐싱

- [ ] **백엔드 Dockerfile 최적화** (`server/Dockerfile`)
  - 현재 Dockerfile 검토
  - 멀티 스테이지 빌드 적용 (필요시)
  - 보안 강화 (non-root user 확인)
  - 헬스체크 최적화

### 2.2 프로덕션 docker-compose.yml 생성
- [ ] `docker-compose.prod.yml` 파일 생성
  - 프로덕션 환경 변수 분리
  - 볼륨 마운트 전략 (로컬 vs 클라우드 스토리지)
  - 네트워크 설정
  - 리소스 제한 설정 (CPU, 메모리)

### 2.3 .dockerignore 파일 최적화
- [ ] 루트 `.dockerignore` 확인/생성
- [ ] `server/.dockerignore` 확인/생성
- [ ] `client/.dockerignore` 확인/생성
- [ ] 불필요한 파일 제외 (node_modules, .git 등)

### 2.4 Docker 이미지 빌드 및 테스트
- [ ] 로컬에서 프로덕션 이미지 빌드 테스트
- [ ] 이미지 크기 확인 및 최적화
- [ ] 컨테이너 실행 테스트
- [ ] 헬스체크 동작 확인

---

## 3단계: 환경 변수 관리 (Secrets Manager) 설정

### 3.1 환경 변수 목록 정리
- [ ] **필수 환경 변수 문서화**
  - 데이터베이스 연결 정보
  - JWT 시크릿
  - OpenAI API 키
  - 이메일 SMTP 설정
  - OAuth 클라이언트 정보
  - CORS 설정
  - 파일 스토리지 설정

- [ ] **환경별 변수 분류**
  - 공통 변수
  - 개발 환경 전용
  - 프로덕션 환경 전용

### 3.2 Secrets Manager 설정
- [ ] **플랫폼별 Secrets Manager 설정**
  - AWS: AWS Secrets Manager 또는 Parameter Store
  - GCP: Secret Manager
  - Azure: Key Vault
  - Railway: Railway Variables
  - Render: Environment Variables

- [ ] **시크릿 생성 및 저장**
  - 각 환경 변수를 Secrets Manager에 저장
  - 접근 권한 설정
  - 버전 관리 설정

### 3.3 환경 변수 로딩 전략
- [ ] **애플리케이션 코드 수정**
  - Secrets Manager에서 환경 변수 로드하는 로직 추가
  - 로컬 개발 환경과 프로덕션 환경 분리
  - 폴백 메커니즘 구현 (환경 변수 → Secrets Manager)

- [ ] **환경 변수 검증 강화**
  - `server/config/envValidator.js` 검토
  - 필수 변수 누락 시 에러 처리
  - 타입 검증 추가

### 3.4 환경 변수 문서화
- [ ] `.env.production.example` 파일 생성
- [ ] `DEPLOYMENT_ENV_VARS.md` 문서 작성
  - 각 변수 설명
  - 설정 방법
  - 보안 주의사항

---

## 4단계: 데이터베이스 마이그레이션 전략 수립

### 4.1 프로덕션 데이터베이스 설정
- [ ] **클라우드 데이터베이스 서비스 선택**
  - AWS RDS (PostgreSQL)
  - GCP Cloud SQL (PostgreSQL)
  - Azure Database for PostgreSQL
  - Railway PostgreSQL
  - Render PostgreSQL
  - 또는 관리형 서비스 없이 컨테이너로 실행

- [ ] **데이터베이스 인스턴스 생성**
  - 리전 선택 (한국 리전 우선)
  - 인스턴스 크기 결정
  - 백업 설정
  - SSL 연결 설정

### 4.2 마이그레이션 스크립트 준비
- [ ] **마이그레이션 실행 전략 수립**
  - 수동 실행 vs 자동 실행
  - 롤백 계획
  - 다운타임 최소화 전략

- [ ] **마이그레이션 스크립트 개선**
  - `scripts/migrate.js` 검토 및 개선
  - 프로덕션 환경용 마이그레이션 스크립트
  - 마이그레이션 상태 확인 스크립트
  - 롤백 스크립트

### 4.3 데이터베이스 백업 전략
- [ ] **백업 계획 수립**
  - 자동 백업 스케줄 설정
  - 백업 보관 기간 결정
  - 백업 복원 테스트 절차

- [ ] **백업 스크립트 개선**
  - `scripts/backup.js` 검토 및 개선
  - 클라우드 스토리지에 백업 저장
  - 백업 암호화

### 4.4 데이터베이스 연결 설정
- [ ] **연결 풀 설정 최적화**
  - 프로덕션 환경에 맞는 풀 크기 조정
  - 타임아웃 설정
  - 재연결 로직

- [ ] **SSL 연결 설정**
  - 프로덕션 DB SSL 인증서 설정
  - 연결 문자열 업데이트

### 4.5 초기 데이터 마이그레이션
- [ ] **마이그레이션 실행 계획**
  - 개발 환경에서 마이그레이션 테스트
  - 프로덕션 마이그레이션 실행 순서
  - 검증 절차

---

## 5단계: CI/CD 파이프라인 구축

### 5.1 CI/CD 플랫폼 선택
- [ ] **플랫폼 비교 및 선택**
  - GitHub Actions (무료, GitHub 통합)
  - GitLab CI/CD
  - CircleCI
  - Jenkins
  - 플랫폼 내장 CI/CD (Railway, Render 등)

### 5.2 GitHub Actions 워크플로우 설정 (예시)
- [ ] **기본 워크플로우 파일 생성** (`.github/workflows/`)
  - `ci.yml`: 테스트 및 린트
  - `deploy.yml`: 배포 자동화

- [ ] **CI 파이프라인 설정**
  - 코드 체크아웃
  - 의존성 설치
  - 린트 실행
  - 테스트 실행
  - 빌드 테스트

- [ ] **CD 파이프라인 설정**
  - Docker 이미지 빌드
  - 이미지 레지스트리에 푸시
  - 클라우드 플랫폼에 배포
  - 마이그레이션 자동 실행 (선택사항)
  - 헬스체크 확인

### 5.3 배포 전략 수립
- [ ] **배포 방식 결정**
  - Blue-Green 배포
  - Rolling 배포
  - Canary 배포
  - 단순 교체 배포

- [ ] **배포 트리거 설정**
  - main/master 브랜치 푸시 시 자동 배포
  - 태그 생성 시 배포
  - 수동 배포 옵션

### 5.4 배포 검증 및 롤백
- [ ] **배포 후 검증 스크립트**
  - 헬스체크 엔드포인트 확인
  - 주요 API 엔드포인트 테스트
  - 데이터베이스 연결 확인

- [ ] **롤백 절차 문서화**
  - 자동 롤백 조건
  - 수동 롤백 방법
  - 이전 버전으로 복구 절차

### 5.5 모니터링 및 알림 설정
- [ ] **로깅 설정**
  - 클라우드 로깅 서비스 연동
  - 로그 집계 및 검색
  - 에러 로그 알림

- [ ] **모니터링 설정**
  - 애플리케이션 성능 모니터링 (APM)
  - 리소스 사용량 모니터링
  - 알림 설정 (이메일, Slack 등)

---

## 6단계: 추가 최적화 및 보안 강화

### 6.1 프론트엔드 빌드 최적화
- [ ] **Vite 빌드 설정 최적화**
  - 코드 스플리팅
  - 압축 설정
  - 환경 변수 주입

- [ ] **CDN 설정** (선택사항)
  - 정적 파일 CDN 배포
  - 캐싱 전략

### 6.2 백엔드 최적화
- [ ] **프로덕션 설정 확인**
  - 압축 미들웨어 활성화
  - 보안 헤더 설정 (Helmet)
  - Rate limiting 설정

### 6.3 파일 스토리지 설정
- [ ] **클라우드 스토리지 설정**
  - AWS S3 / GCP Cloud Storage / Azure Blob Storage
  - 업로드된 파일을 클라우드 스토리지로 이동
  - CDN 연동 (선택사항)

### 6.4 도메인 및 SSL 설정
- [ ] **도메인 구매 및 설정** (다음 단계에서 진행)
  - DNS 설정
  - SSL 인증서 발급 (Let's Encrypt 또는 플랫폼 제공)
  - HTTPS 리다이렉트 설정

### 6.5 보안 강화
- [ ] **보안 체크리스트**
  - 환경 변수 노출 방지
  - API 키 로테이션 계획
  - 데이터베이스 접근 제한
  - 방화벽 규칙 설정
  - DDoS 방어 설정

---

## 체크리스트 요약

### 필수 작업 (우선순위 높음)
1. ✅ 클라우드 플랫폼 선택 및 계정 설정
2. ✅ 프로덕션 Docker 설정 완료
3. ✅ 환경 변수 Secrets Manager 설정
4. ✅ 프로덕션 데이터베이스 생성 및 연결
5. ✅ 기본 CI/CD 파이프라인 구축

### 권장 작업 (우선순위 중간)
6. ⚠️ 데이터베이스 백업 자동화
7. ⚠️ 모니터링 및 알림 설정
8. ⚠️ 파일 스토리지 클라우드 마이그레이션

### 선택 작업 (우선순위 낮음)
9. ⚪ CDN 설정
10. ⚪ 고급 배포 전략 (Blue-Green 등)
11. ⚪ APM 도구 연동

---

## 다음 단계
배포 환경 준비가 완료되면:
- **3단계: 도메인 연결 및 SSL 설정** 진행
- **4단계: 프로덕션 배포 및 테스트** 진행

